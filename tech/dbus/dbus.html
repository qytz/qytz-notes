

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>D-Bus 系列之入门 &mdash; qytz-notes 0.1 文档</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="author" title="关于这些文档" href="../../about.html" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="D-Bus系列之权限配置文件" href="system-dbus.html" />
    <link rel="prev" title="D-Bus 使用" href="index.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> qytz-notes
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Python笔记</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code/index.html">开源代码阅读笔记</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ipynb/index.html">IPython NoteBooks</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">技术笔记</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../PyGObject-Tutorial/index.html">The Python GTK+ 3 Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gstreamer/index.html">GStreamer 开发经验</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pycairo/index.html">Pycairo Documentation</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">D-Bus 使用</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">D-Bus 系列之入门</a></li>
<li class="toctree-l3"><a class="reference internal" href="system-dbus.html">D-Bus系列之权限配置文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="dbus-get-uid.html">D-Bus系列之获取发送者UID及PID的方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../shell-tutorial.html">shell 脚本常用操作入门</a></li>
<li class="toctree-l2"><a class="reference internal" href="../js-bit-operate.html">JavaScript 的移位运算与 IP 地址处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto-make-conf.html">automake 和 autoconf 使用简明教程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../python-bytes-decode.html">Python 3 Bytes.decode 遇到的问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chmod-t.html">Linux粘滞位说明</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mysql-green-start.html">mysql绿色启动方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ldap.html">LDAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security.html">系统安全的思考</a></li>
<li class="toctree-l2"><a class="reference internal" href="../VPN_Advance_Options.html">VPN 高级选项那些事</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sphinx-i11n.html">sphinx 生成本地化的文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git-server.html">简易 git 服务器</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../quant/index.html">量化投资</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../throughts/index.html">瞎想</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">关于我</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html#id2">联系</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">qytz-notes</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">技术笔记</a> &raquo;</li>
        
          <li><a href="index.html">D-Bus 使用</a> &raquo;</li>
        
      <li>D-Bus 系列之入门</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/tech/dbus/dbus.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="d-bus">
<h1>D-Bus 系列之入门<a class="headerlink" href="#d-bus" title="永久链接至标题">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">本文整理自 <a class="reference external" href="http://blog.csdn.net/flowingflying/article/details/5410820">D-Bus 学习系列文章</a></p>
</div>
<div class="section" id="id2">
<h2>背景知识<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>有很多 IPC（interprocess communication ） ，用于不同的解决方案：CORBA 是用于面向对象编程中复杂的 IPC 的一个强大的解决方案。
DCOP 是一个较轻量级的 IPC 框架，功能较少，但是可以很好地集成到 K 桌面环境中。SOAP 和 XML-RPC 设计用于 Web 服务，因而使用 HTTP 作为其传输协议。
D-BUS 设计用于桌面应用程序和 OS 通信。D-Bus（其中 D 原先是代表桌面“Desktop” 的意思），即：用于桌面操作系统的通信总线。
现在逐渐被引入到嵌入式系统中，不过名字还是保留原先的叫法而已。</p>
<p>典型的桌面都会有多个应用程序在运行，而且，它们经常需要彼此进行通信。DCOP 是一个用于 KDE 的解决方案，但是它依赖于 Qt，所以不能用于其他桌面环境之中。
类似的，Bonobo 是一个用于 GNOME 的解决方案，但是非常笨重，因为它是基于 CORBA 的。它还依赖于 GObject，所以也不能用于 GNOME 之外。
D-BUS 的目标是将 DCOP 和 Bonobo 替换为简单的 IPC，并集成这两种桌面环境。
由于尽可能地减少了 D-BUS 所需的依赖，所以其他可能会使用 D-BUS 的应用程序不用担心引入过多依赖。
相对于其它的 IPC, D-Bus 丢掉了一些不必要的、复杂的东西，也正是因为这个原因，D-Bus 比较快、简单。
D-Bus 不和低层的 IPC 直接竞争，比如 sockets, shared memory or message queues. 这些低层点的 IPC 有它们自己的特点，和 D-Bus 并不冲突。</p>
</div>
<div class="section" id="id3">
<h2>什么是 D-Bus<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>D-Bus 是一个为应用程序间通信的消息总线系统，用于进程之间的通信。它是个 3 层架构的 IPC 系统，包括：</p>
<blockquote>
<div><ol class="loweralpha simple">
<li>函数库 libdbus ，用于两个应用程序互相联系和交互消息。</li>
<li>一个基于 libdbus 构造的消息总线守护进程，可同时与多个应用程序相连，并能把来自一个应用程序的消息路由到 0 或者多个其他程序。</li>
<li>基于特定应用程序框架的封装库或捆绑（wrapper libraries or bindings ）。例如，libdbus-glib 和 libdbus-qt，还有绑定在其他语言，例如 Python 的。大多数开发者都是使用这些封装库的 API，因为它们简化了 D-Bus 编程细节。libdbus 被有意设计成为更高层次绑定的底层后端（low-level backend ）。大部分 libdbus 的 API 仅仅是为了用来实现绑定。</li>
</ol>
</div></blockquote>
<p>在 D-Bus 中，“bus”是核心的概念，它是一个通道：不同的程序可以通过这个通道做些操作，比如方法调用、发送信号和监听特定的信号。</p>
<p>D-Bus 是低延迟而且低开销的，设计得小而高效，以便最小化传送的往返时间。另外，协议是二进制的，而不是文本的，这样就排除了费时的序列化过程。
从开发者的角度来看，D-BUS 是易于使用的。有线协议容易理解，客户机程序库以直观的方式对其进行包装。D-Bus 的主要目的是提供如下的一些更高层的功能：</p>
<blockquote>
<div><ol class="loweralpha simple">
<li>结构化的名字空间</li>
<li>独立于架构的数据格式</li>
<li>支持消息中的大部分通用数据元素</li>
<li>带有异常处理的通用远程调用接口</li>
<li>支持广播类型的通信</li>
</ol>
</div></blockquote>
<p>Bus daemon 是一个特殊的进程：这个进程可以从一个进程传递消息给另外一个进程。
当然了，如果有很多 applications 链接到这个通道上，这个 daemon 进程就会把消息转发给这些链接的所有程序。
在最底层，D-Bus 只支持点对点的通信，一般使用本地套接字（AF_UNIX）在应用和 bus daemon 之间通信。
D-Bus 的点对点是经过 bus daemon 抽象过的，由 bus daemon 来完成寻址和发送消息，因此每个应用不必要关心要把消息发给哪个进程。
D-Bus 发送消息通常包含如下步骤（正常情况下）：</p>
<blockquote>
<div><ol class="loweralpha simple">
<li>创建和发送消息 给后台 bus daemon 进程，这个过程中会有两个上下文的切换</li>
<li>后台 bus daemon 进程会处理该消息，并转发给目标进程，这也会引起上下文的切换</li>
<li>目标程序接收到消息，然后根据消息的种类，做不同的响应：要么给个确认、要么应答、还有就是忽略它。最后一种情况对于“通知”类型的消息而言，前两种都会引起进一步的上 下文切换。</li>
</ol>
</div></blockquote>
<p>在一台机器上总线守护有多个实例 (instance)。这些总线之间都是相互独立的。</p>
<dl class="docutils">
<dt><em>一个持久的系统总线（system bus）</em></dt>
<dd>它在引导时就会启动。这个总线由操作系统和后台进程使用，安全性非常好，以使得任意的应用程序不能欺骗系统事件。
它是桌面会话和操作系统的通信，这里操作系统一般而言包括内核和系统守护进程。
这种通道的最常用的方面就是发送系统消息，比如：插入一个新的存储设备；有新的网络连接；等等。</dd>
<dt><em>还将有很多会话总线（session buses）</em></dt>
<dd>这些总线当用户登录后启动，属于那个用户私有。它是用户的应用程序用来通信的一个会话总线。
同一个桌面会话中两个桌面应用程序的通信，可使得桌面会话作为整体集成在一起以解决进程生命周期的相关问题。 这在 GNOME 和 KDE 桌面中大量使用。</dd>
</dl>
<p>综上原因，如果你准备在不同的进程之间传递大量的 数据，D-Bus 可能不是最有效的方法，最有效的方法是使用共享内存，但是对共享内存的管理也是相当复杂的。</p>
</div>
<div class="section" id="id4">
<h2>D-Bus 编程经常涉及的一些概念<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<dl class="docutils">
<dt><em>地址</em></dt>
<dd>连接建立有 server 和 client，对于 bus daemon，应用就是 client，daemon 是 server。
一个 D-Bus 的地址是指 server 用于监听，client 用于连接的地方，例如 unix:path=/tmp/abcedf 标识 server 将在路径 /tmp/abcedf 的 UNIX domain socket 监听。
地址可以是指定的 TCP/IP socket 或者其他在或者将在 D-Bus 协议中定义的传输方式。
如果使用 bus daemon，libdbus 将通过读取环境变量自动获取 session bus damon 的地址，通过检查一个指定的 UNIX domain socket 路径获取 system bus 的地址。如果使用 D-bus，但不是 daemon，需要定义那个应用是 server，那个是 client，并定义一套机制是他们认可 server 的地址，这不是通常的做法。</dd>
<dt><em>Bus Names 总线名字</em></dt>
<dd>当一个应用连接到 bus daemon，daemon 立即会分配一个名字给这个连接，称为 unique connection name，
这个唯一标识的名字以冒号：开头，例如：34-907，这个名字在 daemon 的整个生命周期是唯一的。
但是这种名字总是临时分配，无法确定的，也难以记忆，因此应用可以要求有另外一个名字 well-known name 来对应这个唯一标识，就像我们使用域名来对应 IP 地址一样。
例如可以使用 com.mycompany 来映射：34-907。应用程序可能会要求拥有额外的周知名字（well-known name）。
例如，你可以写一个规范来定义一个名字叫做 com.mycompany.TextEditor。
应用程序就可以发送消息到这个总线名字，对象，和接口以执行方法调用。
当一个应用结束或者崩溃是，OS kernel 会关闭它的总线连接。总线发送 notification 消息告诉其他应用，这个应用的名字已经失去他的 owner。
当检测到这类 notification 时，应用可以知道其他应用的生命周期。这种方式也可用于只有一个实例的应用，即不开启同样的两个应用的情况。</dd>
<dt><em>原生对象和对象路径</em></dt>
<dd>所有使用 D-BUS 的应用程序都包含一些对象，当经由一个 D-BUS 连接受到一条消息时，该消息是被发往一个对象而不是整个应用程序。
在开发中程序框架定义着这样的对象，例如 JAVA，GObject，QObject 等等，在 D-Bus 中成为 native object。
对于底层的 D-Bus 协议，即 libdbus API，并不理会这些 native object，它们使用的是一个叫做 object path 的概念。
通过 object path，高层编程可以为对象实例进行命名，并允许远程应用引用它们。
这些名字看起来像是文件系统路径，易读的路径名是受鼓励的做法，但也允许使用诸如“/com/mycompany/c5yo817y0c1y1c5b”等，只要它可以为你的应用程序所用。
Namespacing 的对象路径以开发者所有的域名开始（如 /org/kde）以避免系统不同代码模块互相干扰。
简单地说：一个应用创建对象实例进行 D-Bus 的通信，这些对象实例都有一个名字，命名方式类似于路径，
例如 /com/mycompany，这个名字在全局（session 或者 system）是唯一的，用于消息的路由。</dd>
<dt><em>Proxies 代理</em></dt>
<dd>代理对象用来表示其他远程的 remote object。
当我们触发了 proxy 对象的 method 时，将会在 D-Bus 上发送一个 method_call 的消息，并等待答复，根据答复返回。使用非常方便，就像调用一个本地的对象。</dd>
<dt><em>接口 Interface</em></dt>
<dd>每一个对象支持一个或者多个接口，接口是一组方法和信号，接口定义一个对象实体的类型。
D-Bus 对接口的命名方式，类似 org.freedesktop.Introspectable。开发人员通常将使用编程语言类的的名字作为接口名字。</dd>
<dt><em>方法和信号 Methods and Signals</em></dt>
<dd>每一个对象有两类成员：方法和信号。方法就是 JAVA 中同样概念，方法是一段函数代码，带有输入和输出。信号是广播给所有兴趣的其他实体，信号可以带有数据 payload。
在 D-BUS 中有四种类型的消息：方法调用（method calls）、方法返回（method returns）、信号（signals）和错误（errors）。
要执行 D-BUS 对象的方法，您需要向对象发送一个方法调用消息。
它将完成一些处理（就是执行了对象中的 Method，Method 是可以带有输入参数的。）并返回，返回消息或者错误消息。
信号的不同之处在于它们不返回任何内容：既没有“信号返回”消息，也没有任何类型的错误消息。</dd>
</dl>
<p>通过上面的描述，我们可以获得下面的视图：:</p>
<blockquote>
<div>Address –&gt; [Bus Name] –&gt; Path –&gt; Interface –&gt; Method</div></blockquote>
<p>bus name 不是必要的，它只在 daemon 的情况下用于路由，点对点的直接连接是不需要的。
简单地说 ：Address 是 D-Bus 中 server 用来监听 client 的地址，当一个 client 连接上 D-Bus，通常是 Daemo 的方式，这个 client 就有了一个 Bus Name。
其他应用可以根据消息中所带的 Bus Name，来判断和哪个应用相关。
消息在总线中传递的时候，传递到应用中，再根据 object path，送至应用中具体的对象实例中，也就是是应用中根据 Interface 创建的对象。
这些 Interface 有 method 和 singal 两种，用来发送、接收、响应消息。</p>
<p>这些概念对初学者可能会有些混淆，但是通过后面学习一个小程序，就很清楚，这是后面一个例子的示意图，回过头来看看之前写的这篇文章，这个示意图或许会更清楚。</p>
<img alt="../../_images/dbus-example.png" src="../../_images/dbus-example.png" />
</div>
<div class="section" id="id5">
<h2>D-Bus 消息类型<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<p>消息通过 D-Bus 在进程间传递。有四类消息：
a. Method call 消息：将触发对象的一个 method
#. Method return 消息：触发的方法返回的结果
#. Error 消息：触发的方法返回一个异常
#. Signal 消息：通知，可以看作为事件消息。</p>
<p>一个消息有消息头 header，里面有 field，有一个消息体 body，里面有参数 arguments。消息头包含消息体的路由信息，消息体就是净荷 payload。头字段可能包括发送者的 bus 名，目的地的 bus 名，方法或者 signal 名等等，其中一个头字段是用于描述 body 中的参数的类型，例如“i”标识 32 位整数，”ii”表示净荷为 2 个 32 为整数。</p>
<div class="section" id="method-call">
<h3>发送 Method call 消息的场景<a class="headerlink" href="#method-call" title="永久链接至标题">¶</a></h3>
<p>一个 method call 消息从进程 A 到进程 B，B 将应答一个 method return 消息或者 error 消息。
在每个 call 消息带有一个序列号，应答消息也包含同样的号码，使之可以对应起来。
他们的处理过程如下：</p>
<blockquote>
<div><ol class="loweralpha simple">
<li>如果提供 proxy，通过触发本地一个对象的方法从而触发另一个进程的远端对象的方法。应用调用 proxy 的一个方法，proxy 构造一个 method call 消息发送到远端进程。</li>
<li>对于底层的 API，不使用 proxy，应用需要自己构造 method call 消息。</li>
<li>一个 method call 消息包含：远端进程的 bus name，方法名字，方法的参数，远端进程中 object path，可选的接口名字。</li>
<li>method call 消息发送到 bus daemon</li>
<li>bus daemon 查看目的地的 bus name。如果一个进程对应这个名字，bus daemon 将 method call 消息发送到该进程中。如果没有发现匹配，bus daemon 创建一个 error 消息作为应答返回。</li>
<li>进程接收后将 method call 消息分拆。对于简单的底层 API 情况，将立即执行方法，并发送一个 method reply 消息给 bus daemon。对于高层的 API，将检查对象 path，interface 和 method，触发一个 native object 的方法，并将返回值封装在一个 method reply 消息中。</li>
<li>bus daemon 收到 method reply 消息，将其转发到原来的进程中</li>
<li>进程查看 method reply 消息，获取返回值。这个响应也可以标识一个 error 的残生。当使用高级的捆绑，method reply 消息将转换为 proxy 方法的返回值或者一个 exception。</li>
</ol>
</div></blockquote>
<p>Bus daemon 保证 message 的顺序，不会乱序。例如我们发送两个 method call 消息到同一个接受方，他们将按顺序接受。接收方并不要求一定按顺序回复。消息有一个序列号了匹配收发消息。</p>
</div>
<div class="section" id="signal">
<h3>发送 Signal 的场景<a class="headerlink" href="#signal" title="永久链接至标题">¶</a></h3>
<p>signal 是个广播的消息，不需要响应，接收方向 daemon 注册匹配的条件，包括发送方和信号名，bus 守护只将信号发送给希望接受的进程。</p>
<p>处理流程如下：</p>
<blockquote>
<div><ol class="loweralpha simple">
<li>一个 signal 消息发送到 bus daemon。</li>
<li>signal 消息包含发布该信号的 interface 名字，signal 的名字，进程的 bus 名字，以及参数。</li>
<li>任何进程都可以注册的匹配条件（match rules) 表明它所感兴趣的 signal。总线有个注册 match rules 列表。</li>
<li>bus daemon 检查那些进程对该信号有兴趣，将信号消息发送到这些进程中。</li>
<li>收到信号的进程决定如何处理。如果使用高层的捆绑，一个 porxy 对象将会释放一个 native 的信号。如果使用底层的 API，进程需要检查信号的发送方和信号的名字决定如何进行处理。</li>
</ol>
</div></blockquote>
<p>Introspection
　　D-Bus 对象可能支持一个接口 org.freedesktop.DBus.Introspectable。该接口有一个方法 Introspect，不带参数，将返回一个 XML string。这个 XML 字符串描述接口，方法，信号。</p>
</div>
</div>
<div class="section" id="id6">
<h2>简单的例子<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<div class="section" id="d-bus-gtype">
<h3>D-Bus 类型和 GType 的映射<a class="headerlink" href="#d-bus-gtype" title="永久链接至标题">¶</a></h3>
<p>在 D-Bus 编程中，基础类型和 GType 的映射表格如下。在后面的程序小例子中我们会看到具体如何对应。</p>
<img alt="../../_images/dbus-map-gtype.png" src="../../_images/dbus-map-gtype.png" />
<p>在 D-Bus 编程中，container 类型和 GType 的映射表格如下：</p>
<img alt="../../_images/dbus-container-gtype.png" src="../../_images/dbus-container-gtype.png" />
<p>在下面的例子中，使用了 dbus-1 dbus-glib-1 glib-2.0。Makefile 的如下：</p>
<div class="highlight-make notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nv">CC</span><span class="o">=</span>gcc

<span class="nv">CFLAGS</span> <span class="o">+=</span> <span class="sb">`</span>pkg-config --cflags dbus-glib-1 glib-2.0<span class="sb">`</span>
<span class="nv">LIBS</span> <span class="o">+=</span> <span class="sb">`</span>pkg-config --libs dbus-glib-1 glib-2.0<span class="sb">`</span>

<span class="nf">all</span><span class="o">:</span> <span class="n">sync_sample</span> <span class="n">async_sample</span> <span class="n">signal_send</span> <span class="n">signal_recv</span> <span class="n">method_service</span> <span class="n">method_call</span>

<span class="nf">async_sample</span><span class="o">:</span> <span class="n">async_sample</span>.<span class="n">c</span>
	<span class="k">$(</span>CC<span class="k">)</span> -Wall -g <span class="k">$(</span>CFLAGS<span class="k">)</span> $&lt; <span class="k">$(</span>LIBS<span class="k">)</span> -o <span class="nv">$@</span>

<span class="nf">sync_sample</span><span class="o">:</span> <span class="n">sync_sample</span>.<span class="n">c</span>
	<span class="k">$(</span>CC<span class="k">)</span> -Wall -g <span class="k">$(</span>CFLAGS<span class="k">)</span> $&lt; <span class="k">$(</span>LIBS<span class="k">)</span> -o <span class="nv">$@</span>

<span class="nf">signal_send</span><span class="o">:</span> <span class="n">signal_send</span>.<span class="n">c</span>
	<span class="k">$(</span>CC<span class="k">)</span> -Wall -g <span class="k">$(</span>CFLAGS<span class="k">)</span> $&lt; <span class="k">$(</span>LIBS<span class="k">)</span> -o <span class="nv">$@</span>

<span class="nf">signal_recv</span><span class="o">:</span> <span class="n">signal_recv</span>.<span class="n">c</span>
	<span class="k">$(</span>CC<span class="k">)</span> -Wall -g <span class="k">$(</span>CFLAGS<span class="k">)</span> $&lt; <span class="k">$(</span>LIBS<span class="k">)</span> -o <span class="nv">$@</span>

<span class="nf">method_service</span><span class="o">:</span> <span class="n">method_service</span>.<span class="n">c</span>
	<span class="k">$(</span>CC<span class="k">)</span> -Wall -g <span class="k">$(</span>CFLAGS<span class="k">)</span> $&lt; <span class="k">$(</span>LIBS<span class="k">)</span> -o <span class="nv">$@</span>

<span class="nf">method_call</span><span class="o">:</span><span class="n">method_call</span>.<span class="n">c</span>
	<span class="k">$(</span>CC<span class="k">)</span> -Wall -g <span class="k">$(</span>CFLAGS<span class="k">)</span> $&lt; <span class="k">$(</span>LIBS<span class="k">)</span> -o <span class="nv">$@</span>

<span class="nf">clean</span><span class="o">:</span>
	rm -f sync_sample async_sample signal_send signal_recv method_service method_call
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id7">
<h3>同步的例子<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<p>同步即程序发出 method call 消息，等待 method_return 消息。下面是一个小例子，如果我们用 dbus-send 命令，可以使用：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>dbus-send --session --print-reply --type<span class="o">=</span>method_call --dest<span class="o">=</span>org.freedesktop.Notifications / org.freedesktop.DBus.Introspectable.Introspect
</pre></div>
</div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dbus/dbus-glib.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">GError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
    <span class="n">DBusGConnection</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
    <span class="n">DBusGProxy</span> <span class="o">*</span><span class="n">proxy</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>

    <span class="cm">/* gtype init */</span>
    <span class="n">error</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="cm">/* connect session bus with dbus_g_get, or DBUS_BUS_SYSTEM connect system bus */</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">dbus_g_bus_get</span><span class="p">(</span><span class="n">DBUS_BUS_SESSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">g_printerr</span><span class="p">(</span><span class="s">&quot;Failed to open connection to bus:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
        <span class="n">g_error_free</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* create a proxy object for  */</span>
    <span class="n">proxy</span> <span class="o">=</span> <span class="n">dbus_g_proxy_new_for_name</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span>
            <span class="s">&quot;org.freedesktop.Notifications&quot;</span><span class="p">,</span> <span class="cm">/* service */</span>
            <span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="cm">/* path */</span>
            <span class="s">&quot;org.freedesktop.DBus.Introspectable&quot;</span><span class="cm">/* interface */</span>
            <span class="p">);</span>
    <span class="n">error</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dbus_g_proxy_call</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="s">&quot;Introspect&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">,</span> <span class="n">G_TYPE_INVALID</span><span class="p">,</span> <span class="n">G_TYPE_STRING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="n">G_TYPE_INVALID</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">domain</span> <span class="o">==</span> <span class="n">DBUS_GERROR</span> <span class="o">&amp;&amp;</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">DBUS_GERROR_REMOTE_EXCEPTION</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">g_printerr</span><span class="p">(</span><span class="s">&quot;Caught remote method exception:%s-%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dbus_g_error_get_name</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">g_printerr</span><span class="p">(</span><span class="s">&quot;Error:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">g_error_free</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">g_print</span><span class="p">(</span><span class="s">&quot;Message Method return from bus:</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
    <span class="n">g_free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
    <span class="n">g_object_unref</span><span class="p">(</span><span class="n">proxy</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id8">
<h3>异步的例子<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<p>异步中，程序将不等返回消息，继续执行，等有返回消息的时候，触发一个回调函数 。下面是同样的操作，但是用异步的方式来实现：</p>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dbus/dbus-glib.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">callback_func</span><span class="p">(</span><span class="n">DBusGProxy</span> <span class="o">*</span><span class="n">proxy</span><span class="p">,</span> <span class="n">DBusGProxyCall</span> <span class="o">*</span><span class="n">call_id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">GError</span> <span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">gchar</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">GMainLoop</span> <span class="o">*</span><span class="n">main_loop</span> <span class="o">=</span> <span class="n">user_data</span><span class="p">;</span>

    <span class="cm">/* 结束一条消息的收发，处理收到的消息 */</span>
    <span class="n">dbus_g_proxy_end_call</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">call_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="n">G_TYPE_STRING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="n">G_TYPE_INVALID</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">g_print</span><span class="p">(</span><span class="s">&quot;Error in method call:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
        <span class="n">g_error_free</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">g_print</span><span class="p">(</span><span class="s">&quot;Success, message:</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">g_main_loop_quit</span><span class="p">(</span><span class="n">main_loop</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">GError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
    <span class="n">DBusGConnection</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
    <span class="n">DBusGProxy</span> <span class="o">*</span><span class="n">proxy</span><span class="p">;</span>
    <span class="n">GMainLoop</span> <span class="o">*</span><span class="n">main_loop</span><span class="p">;</span>

    <span class="n">error</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">main_loop</span> <span class="o">=</span> <span class="n">g_main_loop_new</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
    <span class="cm">/* connect session bus with dbus_g_get, or DBUS_BUS_SYSTEM connect system bus */</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">dbus_g_bus_get</span><span class="p">(</span><span class="n">DBUS_BUS_SESSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">g_printerr</span><span class="p">(</span><span class="s">&quot;Failed to open connection to bus:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
        <span class="n">g_error_free</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* create a proxy object for  */</span>
    <span class="n">proxy</span> <span class="o">=</span> <span class="n">dbus_g_proxy_new_for_name</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span>
            <span class="s">&quot;org.freedesktop.Notifications&quot;</span><span class="p">,</span> <span class="cm">/* service */</span>
            <span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="cm">/* path */</span>
            <span class="s">&quot;org.freedesktop.DBus.Introspectable&quot;</span><span class="cm">/* interface */</span>
            <span class="p">);</span>
    <span class="n">error</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">dbus_g_proxy_begin_call</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="s">&quot;Introspect&quot;</span><span class="p">,</span> <span class="n">callback_func</span><span class="p">,</span> <span class="n">main_loop</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">G_TYPE_INVALID</span><span class="p">);</span>
    <span class="n">g_main_loop_run</span><span class="p">(</span><span class="n">main_loop</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="id9">
<h2>Signal 的收发的例子<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h2>
<p>现在从底层，即 libdbus 学习如何发送 signal，以及如何监听 signal。signal 在 D-Bus 的 Daemon 中广播，为了提高效率，只发送给向 daemon 注册要求该 singal 的对象。
程序，第一步需要将应用和 D-Bus 后台建立连接，也就是和 System D-Bus daemon 或者 Session D-Bus daemon 建立连接。
一旦建立，daemon 会给这条连接分配一个名字，这个名字在 system 或者 session 的生命周期是唯一的，
即 unique connection name，为了方便记忆，可以为这条连接分配一个便于记忆的 well-known name。
对于信号方式，分配这个名字不是必须的（在 method_call 中是需要的，我们在下一次学习中谈到），因为在信号的监听中秩序给出 Interface 的名字和信号名称。
在下面的例子中，可以将相关的代码屏蔽掉，不影响运行，但是通常我们都这样处理，尤其在复杂的程序中。</p>
<p>在我们的例子中，定义这个 BUS name 为 test.singal.source。当然一个好的名字，为了避免于其他应用重复，应当使用 com.mycompany.myfunction 之类的名字。
而 interface 的名字，一般前面和 connection 的 BUS name 一致。</p>
<div class="section" id="id10">
<h3>发送方的程序<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h3>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dbus/dbus-glib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dbus/dbus.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">send_a_signal</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">sigvalue</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DBusError</span> <span class="n">err</span><span class="p">;</span>
    <span class="n">DBusConnection</span> <span class="o">*</span> <span class="n">connection</span><span class="p">;</span>
    <span class="n">DBusMessage</span> <span class="o">*</span> <span class="n">msg</span><span class="p">;</span>
    <span class="n">DBusMessageIter</span> <span class="n">arg</span><span class="p">;</span>
    <span class="n">dbus_uint32_t</span>  <span class="n">serial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="c1">//步骤1:建立与D-Bus后台的连接</span>
    <span class="cm">/* initialise the erroes */</span>
    <span class="n">dbus_error_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="cm">/* Connect to Bus*/</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">dbus_bus_get</span><span class="p">(</span><span class="n">DBUS_BUS_SESSION</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span> <span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dbus_error_is_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Connection Err : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
        <span class="n">dbus_error_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">connection</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//步骤2:给连接名分配一个well-known的名字作为Bus name，这个步骤不是必须的，可以用if 0来注释着一段代码，我们可以用这个名字来检查，是否已经开启了这个应用的另外的进程。</span>
<span class="cp">#if 1</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">dbus_bus_request_name</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="s">&quot;test.singal.source&quot;</span><span class="p">,</span><span class="n">DBUS_NAME_FLAG_REPLACE_EXISTING</span><span class="p">,</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dbus_error_is_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Name Err : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
        <span class="n">dbus_error_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">DBUS_REQUEST_NAME_REPLY_PRIMARY_OWNER</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="c1">//步骤3:发送一个信号</span>
    <span class="c1">//根据图，我们给出这个信号的路径（即可以指向对象），接口，以及信号名，创建一个Message</span>
    <span class="k">if</span><span class="p">((</span><span class="n">msg</span> <span class="o">=</span> <span class="n">dbus_message_new_signal</span> <span class="p">(</span><span class="s">&quot;/test/signal/Object&quot;</span><span class="p">,</span><span class="s">&quot;test.signal.Type&quot;</span><span class="p">,</span><span class="s">&quot;Test&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Message NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//给这个信号（messge）具体的内容</span>
    <span class="n">dbus_message_iter_init_append</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dbus_message_iter_append_basic</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span><span class="n">DBUS_TYPE_STRING</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sigvalue</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Out Of Memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//步骤4: 将信号从连接中发送</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">dbus_connection_send</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">serial</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Out of Memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">dbus_connection_flush</span> <span class="p">(</span><span class="n">connection</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Signal Send</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="c1">//步骤5: 释放相关的分配的内存。</span>
    <span class="n">dbus_message_unref</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span> <span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">send_a_signal</span><span class="p">(</span><span class="s">&quot;Hello,world!&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id11">
<h3>接收该信号的的例子<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h3>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dbus/dbus-glib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dbus/dbus.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">listen_signal</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">DBusMessage</span> <span class="o">*</span> <span class="n">msg</span><span class="p">;</span>
    <span class="n">DBusMessageIter</span> <span class="n">arg</span><span class="p">;</span>
    <span class="n">DBusConnection</span> <span class="o">*</span> <span class="n">connection</span><span class="p">;</span>
    <span class="n">DBusError</span> <span class="n">err</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">sigvalue</span><span class="p">;</span>

    <span class="c1">//步骤1:建立与D-Bus后台的连接</span>
    <span class="n">dbus_error_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">dbus_bus_get</span><span class="p">(</span><span class="n">DBUS_BUS_SESSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dbus_error_is_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Connection Error %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
        <span class="n">dbus_error_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">connection</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//步骤2:给连接名分配一个可记忆名字test.singal.dest作为Bus name，这个步骤不是必须的,但推荐这样处理</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">dbus_bus_request_name</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="s">&quot;test.singal.dest&quot;</span><span class="p">,</span><span class="n">DBUS_NAME_FLAG_REPLACE_EXISTING</span><span class="p">,</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dbus_error_is_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Name Error %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
        <span class="n">dbus_error_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">DBUS_REQUEST_NAME_REPLY_PRIMARY_OWNER</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//步骤3:通知D-Bus daemon，希望监听来行接口test.signal.Type的信号</span>
    <span class="n">dbus_bus_add_match</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="s">&quot;type=&#39;signal&#39;,interface=&#39;test.signal.Type&#39;&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="c1">//实际需要发送东西给daemon来通知希望监听的内容，所以需要flush</span>
    <span class="n">dbus_connection_flush</span><span class="p">(</span><span class="n">connection</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dbus_error_is_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Match Error %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
        <span class="n">dbus_error_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//步骤4:在循环中监听，每隔开1秒，就去试图自己的连接中获取这个信号。这里给出的是从连接中获取任何消息的方式，所以获取后去检查一下这个消息是否我们期望的信号，并获取内容。我们也可以通过这个方式来获取method call消息。</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dbus_connection_read_write</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">dbus_connection_pop_message</span> <span class="p">(</span><span class="n">connection</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="n">dbus_message_is_signal</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="s">&quot;test.signal.Type&quot;</span><span class="p">,</span><span class="s">&quot;Test&quot;</span><span class="p">)</span> <span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dbus_message_iter_init</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Message Has no Param&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">dbus_message_iter_get_arg_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DBUS_TYPE_STRING</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">g_printerr</span><span class="p">(</span><span class="s">&quot;Param is not string&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">dbus_message_iter_get_basic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sigvalue</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Got Singal with value : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">sigvalue</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">dbus_message_unref</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span><span class="c1">//End of while</span>

    <span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span> <span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">){</span>
    <span class="n">listen_signal</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="method">
<h2>Method 的收发小例子<a class="headerlink" href="#method" title="永久链接至标题">¶</a></h2>
<p>现在我们从底层，即 libdbus 学习如何发送 Method 以及如何等待应答，在之前的代码中，我们给出了同步方式的代码 ，这是更为高层的处理方式，建议使用。
监听 method 和监听 signal 的方式非常相似。在给出例子之前，我希望和上次学习一样给出一个示意图，更好地了解 D-Bus 的各个概念。</p>
<img alt="../../_images/method_example.png" src="../../_images/method_example.png" />
<p>在下面的例子中，我们将学习如何在消息中加入多个参数的情况。</p>
<div class="section" id="id12">
<h3>方法监听的例子<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h3>
<p>Method 的监听和 signal 的监听的处理时一样，但是信号是不需要答复，而 Method 需要。</p>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dbus/dbus-glib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dbus/dbus.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="cm">/*读取消息的参数，并且返回两个参数，一个是bool值stat，一个是整数level*/</span>
<span class="kt">void</span> <span class="nf">reply_to_method_call</span><span class="p">(</span><span class="n">DBusMessage</span> <span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="n">DBusConnection</span> <span class="o">*</span> <span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DBusMessage</span> <span class="o">*</span> <span class="n">reply</span><span class="p">;</span>
    <span class="n">DBusMessageIter</span> <span class="n">arg</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">param</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">dbus_bool_t</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">dbus_uint32_t</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">2010</span><span class="p">;</span>
    <span class="n">dbus_uint32_t</span> <span class="n">serial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">//从msg中读取参数，这个在上一次学习中学过</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dbus_message_iter_init</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Message has no args/n&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">dbus_message_iter_get_arg_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DBUS_TYPE_STRING</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Arg is not string!/n&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">dbus_message_iter_get_basic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span><span class="o">&amp;</span> <span class="n">param</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">//创建返回消息reply</span>
    <span class="n">reply</span> <span class="o">=</span> <span class="n">dbus_message_new_method_return</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="c1">//在返回消息中填入两个参数，和信号加入参数的方式是一样的。这次我们将加入两个参数。</span>
    <span class="n">dbus_message_iter_init_append</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dbus_message_iter_append_basic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span><span class="n">DBUS_TYPE_BOOLEAN</span><span class="p">,</span><span class="o">&amp;</span><span class="n">stat</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Out of Memory!/n&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dbus_message_iter_append_basic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span><span class="n">DBUS_TYPE_UINT32</span><span class="p">,</span><span class="o">&amp;</span><span class="n">level</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Out of Memory!/n&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//发送返回消息</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">dbus_connection_send</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serial</span><span class="p">)){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Out of Memory/n&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">dbus_connection_flush</span> <span class="p">(</span><span class="n">conn</span><span class="p">);</span>
    <span class="n">dbus_message_unref</span> <span class="p">(</span><span class="n">reply</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 监听D-Bus消息，我们在上次的例子中进行修改 */</span>
<span class="kt">void</span> <span class="nf">listen_dbus</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">DBusMessage</span> <span class="o">*</span> <span class="n">msg</span><span class="p">;</span>
    <span class="n">DBusMessageIter</span> <span class="n">arg</span><span class="p">;</span>
    <span class="n">DBusConnection</span> <span class="o">*</span> <span class="n">connection</span><span class="p">;</span>
    <span class="n">DBusError</span> <span class="n">err</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">sigvalue</span><span class="p">;</span>

    <span class="n">dbus_error_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="c1">//创建于session D-Bus的连接</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">dbus_bus_get</span><span class="p">(</span><span class="n">DBUS_BUS_SESSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dbus_error_is_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">)){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Connection Error %s/n&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
        <span class="n">dbus_error_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">connection</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//设置一个BUS name：test.wei.dest</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">dbus_bus_request_name</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="s">&quot;test.wei.dest&quot;</span><span class="p">,</span><span class="n">DBUS_NAME_FLAG_REPLACE_EXISTING</span><span class="p">,</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dbus_error_is_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Name Error %s/n&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
        <span class="n">dbus_error_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">DBUS_REQUEST_NAME_REPLY_PRIMARY_OWNER</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//要求监听某个singal：来自接口test.signal.Type的信号</span>
    <span class="n">dbus_bus_add_match</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="s">&quot;type=&#39;signal&#39;,interface=&#39;test.signal.Type&#39;&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="n">dbus_connection_flush</span><span class="p">(</span><span class="n">connection</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dbus_error_is_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">)){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Match Error %s/n&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
        <span class="n">dbus_error_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">while</span><span class="p">(</span><span class="n">TRUE</span><span class="p">){</span>
        <span class="n">dbus_connection_read_write</span> <span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">dbus_connection_pop_message</span> <span class="p">(</span><span class="n">connection</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="n">dbus_message_is_signal</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="s">&quot;test.signal.Type&quot;</span><span class="p">,</span><span class="s">&quot;Test&quot;</span><span class="p">)){</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dbus_message_iter_init</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Message Has no Param&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">dbus_message_iter_get_arg_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DBUS_TYPE_STRING</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">g_printerr</span><span class="p">(</span><span class="s">&quot;Param is not string&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">dbus_message_iter_get_basic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sigvalue</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Got Singal with value : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">sigvalue</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">dbus_message_is_method_call</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="s">&quot;test.method.Type&quot;</span><span class="p">,</span><span class="s">&quot;Method&quot;</span><span class="p">)){</span>
            <span class="c1">//我们这里面先比较了接口名字和方法名字，实际上应当现比较路径</span>
            <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dbus_message_get_path</span> <span class="p">(</span><span class="n">msg</span><span class="p">),</span><span class="s">&quot;/test/method/Object&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">reply_to_method_call</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">connection</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">dbus_message_unref</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span> <span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">listen_dbus</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id13">
<h3>方法调用的例子<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h3>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dbus/dbus-glib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dbus/dbus.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="c1">//建立与session D-Bus daemo的连接，并设定连接的名字，相关的代码已经多次使用过了</span>
<span class="n">DBusConnection</span> <span class="o">*</span>  <span class="nf">connect_dbus</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">DBusError</span> <span class="n">err</span><span class="p">;</span>
    <span class="n">DBusConnection</span> <span class="o">*</span> <span class="n">connection</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="c1">//Step 1: connecting session bus</span>
    <span class="cm">/* initialise the erroes */</span>
    <span class="n">dbus_error_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="cm">/* Connect to Bus*/</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">dbus_bus_get</span><span class="p">(</span><span class="n">DBUS_BUS_SESSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dbus_error_is_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">)){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Connection Err : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
        <span class="n">dbus_error_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">connection</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//step 2: 设置BUS name，也即连接的名字。</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">dbus_bus_request_name</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="s">&quot;test.wei.source&quot;</span><span class="p">,</span><span class="n">DBUS_NAME_FLAG_REPLACE_EXISTING</span><span class="p">,</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dbus_error_is_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Name Err : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
        <span class="n">dbus_error_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">DBUS_REQUEST_NAME_REPLY_PRIMARY_OWNER</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">connection</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">send_a_method_call</span><span class="p">(</span><span class="n">DBusConnection</span> <span class="o">*</span> <span class="n">connection</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DBusError</span> <span class="n">err</span><span class="p">;</span>
    <span class="n">DBusMessage</span> <span class="o">*</span> <span class="n">msg</span><span class="p">;</span>
    <span class="n">DBusMessageIter</span>    <span class="n">arg</span><span class="p">;</span>
    <span class="n">DBusPendingCall</span> <span class="o">*</span> <span class="n">pending</span><span class="p">;</span>
    <span class="n">dbus_bool_t</span> <span class="o">*</span> <span class="n">stat</span><span class="p">;</span>
    <span class="n">dbus_uint32_t</span> <span class="o">*</span> <span class="n">level</span><span class="p">;</span>

    <span class="n">dbus_error_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>

    <span class="c1">//针对目的地地址，请参考图，创建一个method call消息。 Constructs a new message to invoke a method on a remote object.</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">dbus_message_new_method_call</span> <span class="p">(</span><span class="s">&quot;test.wei.dest&quot;</span><span class="p">,</span><span class="s">&quot;/test/method/Object&quot;</span><span class="p">,</span><span class="s">&quot;test.method.Type&quot;</span><span class="p">,</span><span class="s">&quot;Method&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">g_printerr</span><span class="p">(</span><span class="s">&quot;Message NULL&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//为消息添加参数。Append arguments</span>
    <span class="n">dbus_message_iter_init_append</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dbus_message_iter_append_basic</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="n">DBUS_TYPE_STRING</span><span class="p">,</span><span class="o">&amp;</span><span class="n">param</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">g_printerr</span><span class="p">(</span><span class="s">&quot;Out of Memory!&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//发送消息并获得reply的handle 。Queues a message to send, as with dbus_connection_send() , but also returns a DBusPendingCall used to receive a reply to the message.</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dbus_connection_send_with_reply</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pending</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)){</span>
        <span class="n">g_printerr</span><span class="p">(</span><span class="s">&quot;Out of Memory!&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">pending</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">g_printerr</span><span class="p">(</span><span class="s">&quot;Pending Call NULL: connection is disconnected &quot;</span><span class="p">);</span>
        <span class="n">dbus_message_unref</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">dbus_connection_flush</span><span class="p">(</span><span class="n">connection</span><span class="p">);</span>
    <span class="n">dbus_message_unref</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

    <span class="c1">//waiting a reply，在发送的时候，已经获取了method reply的handle，类型为DBusPendingCall。</span>
    <span class="c1">// block until we recieve a reply， Block until the pending call is completed.</span>
    <span class="n">dbus_pending_call_block</span> <span class="p">(</span><span class="n">pending</span><span class="p">);</span>
    <span class="c1">// get the reply message，Gets the reply, or returns NULL if none has been received yet.</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">dbus_pending_call_steal_reply</span> <span class="p">(</span><span class="n">pending</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Reply Null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
         <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
     <span class="c1">// free the pending message handle</span>
     <span class="n">dbus_pending_call_unref</span><span class="p">(</span><span class="n">pending</span><span class="p">);</span>
    <span class="c1">// read the parameters</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dbus_message_iter_init</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Message has no arguments!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">dbus_message_iter_get_arg_type</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DBUS_TYPE_BOOLEAN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Argument is not boolean!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">dbus_message_iter_get_basic</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dbus_message_iter_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Message has too few arguments!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">dbus_message_iter_get_arg_type</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DBUS_TYPE_UINT32</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Argument is not int!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">dbus_message_iter_get_basic</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Got Reply: %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">stat</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">level</span><span class="p">);</span>
    <span class="n">dbus_message_unref</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span> <span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DBusConnection</span> <span class="o">*</span> <span class="n">connection</span><span class="p">;</span>

    <span class="n">connection</span> <span class="o">=</span> <span class="n">connect_dbus</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">connection</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">send_a_method_call</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="s">&quot;Hello, D-Bus&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="xml-d-bus">
<h2>使用 xml 定义 D-Bus 接口<a class="headerlink" href="#xml-d-bus" title="永久链接至标题">¶</a></h2>
<p>在 D-Bus 中，可以将 D-Bus 接口定义用 XML 格式表述处理，并利用工具，自动生成头文件，给出工整的调用方式。</p>
<p>下面是一个 XML 的例子。</p>
<div class="section" id="id14">
<h3>客户端<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h3>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">&quot;1.0&quot;</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span> <span class="o">?&gt;</span>

<span class="o">&lt;</span><span class="n">node</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;/com/wei/MyObject&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">interface</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;com.wei.MyObject.Sample&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">method</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Test&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">annotation</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;org.freedesktop.DBus.GLib.CSymbol&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s">&quot;wei_response&quot;</span> <span class="o">/&gt;</span> 
            <span class="o">&lt;</span><span class="n">arg</span> <span class="n">type</span><span class="o">=</span><span class="s">&quot;u&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;x&quot;</span> <span class="n">direction</span><span class="o">=</span><span class="s">&quot;in&quot;</span> <span class="o">/&gt;</span>
            <span class="o">&lt;</span><span class="n">arg</span> <span class="n">type</span><span class="o">=</span><span class="s">&quot;d&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;d_ret&quot;</span> <span class="n">direction</span><span class="o">=</span><span class="s">&quot;out&quot;</span> <span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="n">method</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">interface</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">node</span><span class="o">&gt;</span>

</pre></div>
</td></tr></table></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>dbus-binding-tool --mode<span class="o">=</span>glib-client --prefix<span class="o">=</span>com_wei wei.xml &gt; wei_client.h
</pre></div>
</div>
</div>
<div class="section" id="id15">
<h3>服务端<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h3>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">&quot;1.0&quot;</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span> <span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="n">node</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;/com/wei/MyObject&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">interface</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;com.wei.MyObject.Sample&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">method</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Test&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">arg</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;x&quot;</span> <span class="n">type</span><span class="o">=</span><span class="s">&quot;u&quot;</span> <span class="n">direction</span><span class="o">=</span><span class="s">&quot;in&quot;</span> <span class="o">/&gt;</span>
            <span class="o">&lt;</span><span class="n">arg</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;d_ret&quot;</span> <span class="n">type</span><span class="o">=</span><span class="s">&quot;d&quot;</span> <span class="n">direction</span><span class="o">=</span><span class="s">&quot;out&quot;</span> <span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="n">method</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">interface</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">node</span><span class="o">&gt;</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>dbus-binding-tool --mode<span class="o">=</span>glib-server --prefix<span class="o">=</span>com_wei wei.xml &gt; wei_server.h
</pre></div>
</div>
</div>
</div>
<div class="section" id="id16">
<h2>其他参考资料<a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h2>
<p>缓存版：</p>
<ol class="arabic simple">
<li><a class="reference download internal" href="../../_downloads/qtdbus.pdf" download=""><code class="xref download docutils literal notranslate"><span class="pre">Nokia</span> <span class="pre">D-Bus</span> <span class="pre">page</span></code></a></li>
<li><a class="reference download internal" href="../../_downloads/qt-dbus-example.pdf" download=""><code class="xref download docutils literal notranslate"><span class="pre">KDE</span> <span class="pre">Base</span> <span class="pre">D-Bus</span> <span class="pre">example</span></code></a></li>
<li><a class="reference download internal" href="../../_downloads/qt-dbus-telepathy.pdf" download=""><code class="xref download docutils literal notranslate"><span class="pre">telepathy</span> <span class="pre">D-Bus</span> <span class="pre">page</span></code></a></li>
</ol>
<p>原始链接</p>
<ol class="arabic simple">
<li><a class="reference external" href="http://developer.nokia.com/community/wiki/QtDbus_quick_tutorial">Nokia D-Bus page</a></li>
<li><a class="reference external" href="http://techbase.kde.org/Development/Tutorials/D-Bus/CustomTypes?setlang=zh-cn#Generate_Adaptor_and_Interface_classes">KDE Base D-Bus example</a></li>
<li><a class="reference external" href="http://telepathy.freedesktop.org/doc/book/sect.basics.dbus.html">telepathy D-Bus page</a></li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="system-dbus.html" class="btn btn-neutral float-right" title="D-Bus系列之权限配置文件" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="D-Bus 使用" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, qytz(lennyh).
      最后更新于 2019 年 05 月 16 日.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1',
            LANGUAGE:'zh_CN',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/translations.js"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>